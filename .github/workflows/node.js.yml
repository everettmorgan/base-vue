name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      CI: true

    steps:
    - uses: actions/checkout@v4

    - name: Enable Corepack (Yarn 4)
      run: corepack enable

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: yarn
        cache-dependency-path: yarn.lock

    - name: Install dependencies
      run: yarn install --immutable

    - name: Cache Cypress binary
      uses: actions/cache@v4
      with:
        path: ~/.cache/Cypress
        key: cypress-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          cypress-${{ runner.os }}-

    - name: Run tests (yarn test:headless)
      uses: cypress-io/github-action@v6
      with:
        install: false
        command: yarn test:headless